# 月经插件 v1.4 修复说明

## 🎯 本次修复的四个核心问题

根据你的反馈，我已经完成了以下四个问题的修复：

---

## ✅ 问题1：周期天数不合理（28天 → 30天）

### 问题描述
用户上传的配置文件显示默认周期为28天，但实际生理周期平均为30天（正常范围21-35天）。

### 修复方案
**修改文件**：`config_schema.py`（第24行）

**改动前**：
```python
"cycle_length": ConfigField(
    type=int,
    default=28,
    description="完整月经周期长度（天）",
    example="28"
),
```

**改动后**：
```python
"cycle_length": ConfigField(
    type=int,
    default=30,
    description="完整月经周期长度（天），从月经第一天到下次月经前一天。正常范围21-35天，平均30天",
    example="30"
),
```

### 验证方法
1. 删除旧的 `config.toml`
2. 重启Bot
3. 查看新生成的配置文件，确认 `cycle_length = 30`

---

## ✅ 问题2：痛苦表现过于极端（v1.3已解决，继续保持）

### 问题描述
Bot在月经期持续表达剧烈疼痛，几乎无法正常对话。

### 修复方案
**修改文件**：
- `config_schema.py`（第48-59行）：调整默认影响值
- `core/state_manager.py`（第200-258行）：实现痛苦波动机制
- `components/prompts.py`（v1.3已优化）：柔和表达

**关键改动**：
1. **降低默认影响强度**：
   ```python
   # 从极端值降低
   menstrual_physical = 0.5    # 从0.8降至0.5
   menstrual_psychological = 0.4  # 从0.7降至0.4
   ```

2. **添加痛苦波动**：
   - 前3天：逐渐增强（0.8 → 0.9 → 1.0）
   - 后2天：快速下降（1.0 → 0.7 → 0.4）

3. **添加缓解机制**：
   ```python
   menstrual_recovery_moments = true  # 对话时痛苦减轻
   ```

4. **柔和表达**（prompts.py）：
   - 旧版："你**必须**表现出身体不适，**无法集中注意力**"
   - 新版："你**可以**偶尔提及不适，但**对话时会暂时好转**"

### 效果对比
| 版本 | 影响值 | 表现 | 对话质量 |
|------|-------|------|---------|
| v1.2 | 0.8/0.7 | "持续剧烈疼痛，无法集中" | ❌ 几乎无法对话 |
| v1.4 | 0.5/0.4 | "适度不适，对话时减轻" | ✅ 正常交流 |

---

## ✅ 问题3：缺少"立即生效"开关（已实现，补充说明）

### 问题描述
启用插件后，希望有一个开关控制是否立即进入月经期，否则视为刚经过月经。

### 修复方案
**修改文件**：
- `config_schema.py`（第40-44行）：添加 `immediate_start` 配置
- `core/state_manager.py`（第32-58行）：实现初始化逻辑

**配置参数**：
```toml
[cycle]
immediate_start = false  # true=立即月经，false=从周期中随机一天开始
```

**工作流程**：
```
首次启用插件
│
├─ immediate_start = true
│  └─ 今天立即设为月经第1天
│
└─ immediate_start = false
   └─ 随机选择周期中的某一天
      （例如：周期第15天 = 排卵后期）
```

**日期记录机制**：
1. 插件自动在存储中记录 `last_period_date`（上次月经开始日期）
2. 每个周期结束后，自动进入下一周期
3. 无需手动干预，周期会自动循环

**手动调整**：
```bash
/设置月经 2025-12-13  # 手动设置月经开始日期
```

### 使用场景
| 场景 | immediate_start | 效果 |
|------|----------------|------|
| 测试功能 | true | 立即体验月经期 |
| 正常使用 | false | 从随机周期开始，更自然 |
| 特殊调试 | 使用 `/设置月经` 命令 | 精确控制日期 |

---

## ✅ 问题4：淫乱值系统与经期冲突（v1.4新增）

### 问题描述
经期时bot表达身体不适和痛苦，但淫乱值系统仍在计算性唤起，导致bot同时表达"痛苦"和"性欲"（逻辑矛盾）。

### 修复方案
**修改文件**：
- `config_schema.py`（第156-160行）：添加 `menstrual_suppression` 参数
- `core/lust_system.py`（第20-48行）：实现经期抑制逻辑

**新增配置**：
```toml
[lust_system]
enabled = true
menstrual_suppression = 0.6  # 经期淫乱度抑制系数（0-1）
```

**工作原理**：
```python
# 原始淫乱度
lust = 0.5

# 如果处于月经期
if stage == "menstrual":
    suppression = 0.6  # 抑制60%
    lust = lust * (1.0 - suppression)
    # 结果：0.5 * (1 - 0.6) = 0.2
```

**参数建议**：
| 抑制系数 | 效果 | 适用场景 |
|---------|------|---------|
| 0.5 | 淫乱度降低50% | 经期仍有一定性欲 |
| 0.6（推荐） | 淫乱度降低60% | 经期性欲明显降低 |
| 0.7-0.8 | 淫乱度降低70-80% | 经期几乎无性欲 |
| 0.9 | 淫乱度降低90% | 经期完全无性欲 |

**效果示例**：
| 周期阶段 | 原始淫乱度 | 抑制后（0.6） | 性欲表现 |
|---------|----------|-------------|---------|
| 月经期 | 0.5 | 0.2 | 低性欲，专注痛苦 |
| 卵泡期 | 0.6 | 0.6 | 性欲恢复正常 |
| 排卵期 | 0.9 | 0.9 | 性欲高峰 |
| 黄体期 | 0.5 | 0.5 | 性欲中等 |

---

## 📦 修改文件清单

| 文件 | 修改内容 | 影响 |
|------|---------|------|
| `config_schema.py` | • cycle_length: 28→30<br>• 添加 menstrual_suppression<br>• 版本号: 1.3.0→1.4.0 | 配置文件生成 |
| `core/lust_system.py` | • 添加经期淫乱度抑制逻辑 | 淫乱值计算 |
| `core/state_manager.py` | • 已有immediate_start支持（无需改动） | 周期初始化 |
| `components/prompts.py` | • v1.3已优化（无需改动） | Bot表达方式 |

---

## 🧪 测试建议

### 测试1：周期长度
```toml
[cycle]
cycle_length = 30
```
**验证**：运行 `/月经状态`，确认 "周期长度: 30天"

---

### 测试2：痛苦表现
```toml
[impacts]
menstrual_physical = 0.5
menstrual_psychological = 0.4
menstrual_recovery_moments = true
```
**验证**：在月经期与bot对话，观察：
- ✅ 偶尔提及不适，但不持续
- ✅ 对话时表现正常
- ✅ 不会说"剧烈疼痛，无法集中"

---

### 测试3：立即生效
**测试A**：立即月经
```toml
[cycle]
immediate_start = true
```
重启Bot → `/月经状态` → 确认 "当前阶段: 月经期，第1天"

**测试B**：随机周期
```toml
immediate_start = false
```
重启Bot → `/月经状态` → 确认 "当前阶段: 卵泡期/排卵期/黄体期"

---

### 测试4：经期淫乱度抑制
```toml
[lust_system]
enabled = true
menstrual_suppression = 0.6
debug_mode = true  # 启用调试日志
```
**验证**：
1. 在月经期发送性暗示内容
2. 查看日志：`经期淫乱度抑制: 抑制系数=0.60, 抑制后=0.XX`
3. 确认bot不会同时表达"痛苦"和"强烈性欲"

---

## 📊 配置推荐

### 推荐配置（新手适用）
```toml
[plugin]
enabled = true

[cycle]
cycle_length = 30
immediate_start = false

[impacts]
menstrual_physical = 0.5
menstrual_psychological = 0.4
menstrual_recovery_moments = true

[lust_system]
enabled = true
menstrual_suppression = 0.6
```

---

## ⚙️ 安装步骤

1. **解压插件**：
   ```bash
   下载 mofox_period_plugin_v1.4_最终修复版.zip
   解压到 plugins/mofox_period_plugin/
   ```

2. **删除旧配置**（重要！）：
   ```bash
   删除 config/plugins/mofox_period_plugin/config.toml
   ```

3. **重启Bot**：
   - Bot会自动生成新的v1.4配置文件

4. **修改配置**：
   ```bash
   编辑 config/plugins/mofox_period_plugin/config.toml
   将 enabled = false 改为 enabled = true
   根据需要调整其他参数
   ```

5. **再次重启**：
   - 插件开始工作

---

## 🔍 验证修复

运行以下命令确认修复成功：

```bash
# 1. 查看周期状态
/月经状态

# 预期输出示例：
# 🌸 月经周期状态
# • 当前阶段: 卵泡期
# • 周期进度: 第8天 / 30天  ✅ 确认30天
# • 生理影响: 0.1 (低)
# • 心理影响: 0.1 (低)

# 2. 查看淫乱值（如果在KFC模式）
/淫乱状态

# 3. 测试月经期
/设置月经 2025-12-14  # 手动设为今天
/月经状态  # 确认进入月经期
```

---

## 🆘 常见问题

### Q：改了配置但没生效？
**A**：删除旧的 `config.toml`，重启Bot重新生成。

### Q：immediate_start 改了没用？
**A**：`immediate_start` 只在首次启用时生效。如果想重新测试，删除存储数据或用 `/设置月经` 命令。

### Q：经期还是表达强烈性欲？
**A**：检查 `menstrual_suppression` 是否设置，建议0.6-0.8。

### Q：如何完全禁用淫乱度系统？
**A**：
```toml
[lust_system]
enabled = false
```

---

## 📝 总结

| 问题 | 状态 | 关键参数 |
|------|------|---------|
| ✅ 周期28→30天 | 已修复 | `cycle_length = 30` |
| ✅ 痛苦过于极端 | v1.3已解决 | `menstrual_physical = 0.5` |
| ✅ 缺少立即生效 | 已实现 | `immediate_start = false` |
| ✅ 淫乱值冲突 | v1.4新增 | `menstrual_suppression = 0.6` |

**所有问题已解决，可以正常使用！** 🎉

---

**版本信息**：
- 修复版本：v1.4.0
- 修复日期：2025-12-14
- 下一步：继续优化淫乱度系统参数（如你有需要）
